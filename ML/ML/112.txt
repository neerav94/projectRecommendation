Market Response to Liquidity Shocks in the Limit Order Book

Kartikey Asthana∗,

Roberto A. Col´on Qui˜nones†,

Joshua Romero‡

Stanford University, CS229 Machine Learning, Autumn 2015

Abstract

This report provides empirical evidence that the bid-ask
spread and mid-price exhibit strong mean reversion follow-
ing a liquidity shock in the limit order book. The mean
behavior of buy/sell initiated shocks is to increase/decrease
the macroscopic mid-price of the security. Linear as well
as non-linear models are trained to incorporate pre-shock
information for predicting post-shock behavior. However,
the features tend to add very little predictive power be-
yond the statistical mean behavior. We show that this is
largely on account of high volatility associated with high
priced securities. Deﬁning a measure of error which is nor-
malized by volatility indicates that features do have some
intrinsic predictive capability. In this new measure, linear
regression, weighted to account for heteroskedasticity, out-
performs SVR yielding an eﬃcient prediction algorithm for
high frequency data.

1

Introduction

Exchange-traded ﬁnancial instruments often incorporate a
transparent buyer-seller matching system known as a cen-
tral limit order book. For each security, this book maintains
a real-time record of bid/ask prices and volumes that market
participants are willing to trade at. The diﬀerence between
the highest bid and lowest ask price is referred to as the
bid-ask spread and is typically narrow for actively traded
securities. This spread is a quantitative measure of the se-
curity’s liquidity since a narrow spread implies a smaller
premium to be paid for buying/selling and vice-versa.

A trade is executed when a buyer/seller is willing to cross
the bid-ask spread. If the buyer/seller places a large enough
order that consumes all available volume at the best price,
then the bid-ask spread changes, leading to a liquidity shock.
Such a shock is followed by a period during which partic-
ipants replenish the order book with new bid/ask orders.
Such limit orders that update the best bid/ask price are
referred to as quote events.

The rate of recovery or mean reversion of the spread and
mid-price is indicative of the market’s resiliency and is of
great importance to traders, exchanges and regulators. An
eﬃcient and accurate model for market resiliency can di-
rectly beneﬁt traders, allowing them to reduce market im-
pact costs by splitting large orders across time. Moreover,

∗PhD candidate, kasthana@stanford.edu
†PhD candidate, racolon@stanford.edu
‡PhD candidate, jdromero@stanford.edu

such a model can improve existing back-testing platforms for
trading strategies by including a feedback from the market.
The goal of this project is to develop an accurate model for
predicting the short-term response of the market to liquidity
shocks in the order book. In particular, we are interested
in forecasting values of the best bid and best ask prices for
ﬁfty time steps following an order that triggers a liquidity
shock. The input to our algorithm consists of information on
ﬁfty pre-shock transactions, the shock-causing transaction,
as well as macroscopic indicators regarding each security.
We then use variants of linear regression (LR) and support
vector regression (SVR) to predict increments in mid-price
and bid-ask spread for the ﬁfty time steps after the shock.

2 Related work

Numerous stochastic models have been proposed for the
state of a limit order book. These include static models [1]
where the trader’s choice to place limit or market orders is
made exogenously, as well as dynamic models [2] that make
such a choice internally by factoring waiting costs. It has
been shown [3] that liquidity shocks temporarily increase
the bid-ask spread which reverts to a competitive level as
new orders arrive. We empirically verify this observation in
Section 3.1. Dynamics of market resiliency have also been
studied in [4] where the authors show that the two prin-
cipal factors governing the rate of mean reversion are the
proportion of patient traders and rate of order arrival.

It is important to note that a liquidity shock in the limit
order book is a high frequency phenomenon wherein the
change in spread is on the order of a few ticks. It must be
contrasted with macroscopic shocks during ﬁnancial crises
wherein the bid-ask spread widens catastrophically imped-
ing traders from closing positions. Extensive investigations
have been conducted into the dynamics of macroscopic liq-
uidity across equity and bond markets [5], premia associated
with shocks in equilibrium markets [6], impact of macro-
scopic shocks on HFT participants [7], shocks due to federal
monetary policies [8] etc.

Linear
k-Nearest
Regress. Neighbors

0.778

0.786

0.796

SVR Random k-Means

Forest
0.797

0.798

Table 1: Relative performance (RMSE) of algorithms uti-
lized by a top-ranking kaggle.com competition participant.

This problem was part of a competition sponsored by the
Capital Markets Cooperative Research Centre, hosted on-

1

Market Response to Liquidity Shocks in the Limit Order Book

Kartikey Asthana∗,

Roberto A. Col´on Qui˜nones†,

Joshua Romero‡

Stanford University, CS229 Machine Learning, Autumn 2015

Abstract

This report provides empirical evidence that the bid-ask
spread and mid-price exhibit strong mean reversion follow-
ing a liquidity shock in the limit order book. The mean
behavior of buy/sell initiated shocks is to increase/decrease
the macroscopic mid-price of the security. Linear as well
as non-linear models are trained to incorporate pre-shock
information for predicting post-shock behavior. However,
the features tend to add very little predictive power be-
yond the statistical mean behavior. We show that this is
largely on account of high volatility associated with high
priced securities. Deﬁning a measure of error which is nor-
malized by volatility indicates that features do have some
intrinsic predictive capability. In this new measure, linear
regression, weighted to account for heteroskedasticity, out-
performs SVR yielding an eﬃcient prediction algorithm for
high frequency data.

1

Introduction

Exchange-traded ﬁnancial instruments often incorporate a
transparent buyer-seller matching system known as a cen-
tral limit order book. For each security, this book maintains
a real-time record of bid/ask prices and volumes that market
participants are willing to trade at. The diﬀerence between
the highest bid and lowest ask price is referred to as the
bid-ask spread and is typically narrow for actively traded
securities. This spread is a quantitative measure of the se-
curity’s liquidity since a narrow spread implies a smaller
premium to be paid for buying/selling and vice-versa.

A trade is executed when a buyer/seller is willing to cross
the bid-ask spread. If the buyer/seller places a large enough
order that consumes all available volume at the best price,
then the bid-ask spread changes, leading to a liquidity shock.
Such a shock is followed by a period during which partic-
ipants replenish the order book with new bid/ask orders.
Such limit orders that update the best bid/ask price are
referred to as quote events.

The rate of recovery or mean reversion of the spread and
mid-price is indicative of the market’s resiliency and is of
great importance to traders, exchanges and regulators. An
eﬃcient and accurate model for market resiliency can di-
rectly beneﬁt traders, allowing them to reduce market im-
pact costs by splitting large orders across time. Moreover,

∗PhD candidate, kasthana@stanford.edu
†PhD candidate, racolon@stanford.edu
‡PhD candidate, jdromero@stanford.edu

such a model can improve existing back-testing platforms for
trading strategies by including a feedback from the market.
The goal of this project is to develop an accurate model for
predicting the short-term response of the market to liquidity
shocks in the order book. In particular, we are interested
in forecasting values of the best bid and best ask prices for
ﬁfty time steps following an order that triggers a liquidity
shock. The input to our algorithm consists of information on
ﬁfty pre-shock transactions, the shock-causing transaction,
as well as macroscopic indicators regarding each security.
We then use variants of linear regression (LR) and support
vector regression (SVR) to predict increments in mid-price
and bid-ask spread for the ﬁfty time steps after the shock.

2 Related work

Numerous stochastic models have been proposed for the
state of a limit order book. These include static models [1]
where the trader’s choice to place limit or market orders is
made exogenously, as well as dynamic models [2] that make
such a choice internally by factoring waiting costs. It has
been shown [3] that liquidity shocks temporarily increase
the bid-ask spread which reverts to a competitive level as
new orders arrive. We empirically verify this observation in
Section 3.1. Dynamics of market resiliency have also been
studied in [4] where the authors show that the two prin-
cipal factors governing the rate of mean reversion are the
proportion of patient traders and rate of order arrival.

It is important to note that a liquidity shock in the limit
order book is a high frequency phenomenon wherein the
change in spread is on the order of a few ticks. It must be
contrasted with macroscopic shocks during ﬁnancial crises
wherein the bid-ask spread widens catastrophically imped-
ing traders from closing positions. Extensive investigations
have been conducted into the dynamics of macroscopic liq-
uidity across equity and bond markets [5], premia associated
with shocks in equilibrium markets [6], impact of macro-
scopic shocks on HFT participants [7], shocks due to federal
monetary policies [8] etc.

Linear
k-Nearest
Regress. Neighbors

0.778

0.786

0.796

SVR Random k-Means

Forest
0.797

0.798

Table 1: Relative performance (RMSE) of algorithms uti-
lized by a top-ranking kaggle.com competition participant.

This problem was part of a competition sponsored by the
Capital Markets Cooperative Research Centre, hosted on-

1

line at kaggle.com [9]. The competition ended in January
2012 and a discussion ensued wherein participants shared
performance of their algorithms on an undisclosed test set.
Table 1 shows the root mean squared error obtained from
six diﬀerent algorithms. The proximity of results indicates
that there is negligible predictive ability in the features! In
this report, we show how this observation can be veriﬁed,
explained and then circumvented.

that the expected mid and spread are given by
−αM (t−t0) + µM ,
−αS (t−t0) + µS,

E[Mt] = (Mt0 − µM )e
E[St] = (St0 − µS)e

(3)

where t0 = 49 is the time of incidence of the shock. The
exponential damping in time is a strong indicator of mean-
reversion and can be veriﬁed using the empirical estimators

3 Data and Benchmark

ˆE[Mt − Mt0] =

1
m

(Mt

(i) − Mt0

(i)),

m(cid:88)
m(cid:88)

i=1

i=1

Trade and quote (TAQ) data for 110,000 examples of liquid-
ity shocks across several securities and trading times were
obtained directly from the competition website. Each exam-
ple includes information on 50 transactions leading to the
shock and an equal number after the shock. All prices are
measured in units of pence. For pre-shock transactions, the
data provides (i) nature (trade/quote), (ii) time, (iii) best
bid price, and (iv) best ask price for each transaction. Re-
garding the shock itself, we are provided (i) volume-weighted
average price, (ii) volume, and (iii) nature (buy/sell initi-
ated) of the trade causing the liquidity shock. Addition-
ally, we are also provided (i) the number of previous day
on-market trades, and (ii) sum of previous day on-market
trade values. For post-shock transactions, only data on bid
and ask prices is available.

Of the total data, 80,000 examples were randomly chosen
to form the training set, 20,000 were held out for optimizing
parameters in SVR and the remaining 10,000 were desig-
nated as the test set.

3.1 Mean-reversion of mid and spread

Prior to exploring learning algorithms, we begin with a sta-
tistical characterization of the provided high-frequency data
to verify the observations in [3]. Denoting Bt, At as the
best bid and ask prices for a given time t, the mid price and
bid-ask spread are respectively deﬁned as

Mt =

At + Bt

2

, St = At − Bt.

(1)

For liquid securities, both the mid-price and spread are of-
ten assumed to be mean reverting over short time horizons,
i.e. they have a tendency to return to some non-observable
mean levels. The time series for both quantities can then be
represented by Ornstein-Uhlenbeck (OU) processes [10],

,

t

dMt = αM (µM − Mt)dt + σM dBM
dSt = αS(µS − St)dt + σSdBS
t ,
where BM
, BS
t are standard Brownian motions, σM , σS
t
are the respective volatilities, µM , µS are the mean levels,
and the critical quantities αM , αS are the rates of mean
reversion. The two processes are correlated Cov(BM
t ) =
t
ρt. Owing to linearity in the diﬀusion term, one can show

, BS

(2)

2

ˆE[St − St0] =

1
m

(St

(i) − St0

(i)),

(4)

as a function of time, where m denotes the number of ex-
amples. The post-shock values of these quantities for the
training set are plotted in Fig. 1. A distinction is made
between buy-initiated and sell-initiated shocks as they in-
ﬂuence the mid-price in opposite directions. We see that
both the mid-price and bid-ask spread exhibit strong mean
reversion.
In the case of a buy-initiated shock, the mean
level is higher than than the value prior to the shock, i.e.
the shock increases the long-term or macro level price of
the security. The corresponding decrease happens for a sell-
initiated stock. This phenomenon captures the basic process
by which securities change in value over time. The mean
level for the spread is slightly higher than the pre-shock
level. This highlights the impact of the shock in reducing
liquidity of the security.

Figure 1: Mean reversion of mid-price and bid-ask spread

3.2 Benchmark

We use the statistical estimators in Eqn. (4) as our bench-
mark algorithm,

ˆMt = Mt0 + ˆE[Mt − Mt0],
ˆBt = ˆMt − ˆSt/2,

ˆAt = ˆMt + ˆSt/2,

ˆSt = St0 + ˆE[St − St0 ],

(5)

2468101214−0.5−0.4−0.3−0.2−0.100.10.20.30.40.5t−t0ˆE[Mt−Mt0],ˆE[St−St0]  mid−price − buy−initmid−price − sell−initspreadMarket Response to Liquidity Shocks in the Limit Order Book

Kartikey Asthana∗,

Roberto A. Col´on Qui˜nones†,

Joshua Romero‡

Stanford University, CS229 Machine Learning, Autumn 2015

Abstract

This report provides empirical evidence that the bid-ask
spread and mid-price exhibit strong mean reversion follow-
ing a liquidity shock in the limit order book. The mean
behavior of buy/sell initiated shocks is to increase/decrease
the macroscopic mid-price of the security. Linear as well
as non-linear models are trained to incorporate pre-shock
information for predicting post-shock behavior. However,
the features tend to add very little predictive power be-
yond the statistical mean behavior. We show that this is
largely on account of high volatility associated with high
priced securities. Deﬁning a measure of error which is nor-
malized by volatility indicates that features do have some
intrinsic predictive capability. In this new measure, linear
regression, weighted to account for heteroskedasticity, out-
performs SVR yielding an eﬃcient prediction algorithm for
high frequency data.

1

Introduction

Exchange-traded ﬁnancial instruments often incorporate a
transparent buyer-seller matching system known as a cen-
tral limit order book. For each security, this book maintains
a real-time record of bid/ask prices and volumes that market
participants are willing to trade at. The diﬀerence between
the highest bid and lowest ask price is referred to as the
bid-ask spread and is typically narrow for actively traded
securities. This spread is a quantitative measure of the se-
curity’s liquidity since a narrow spread implies a smaller
premium to be paid for buying/selling and vice-versa.

A trade is executed when a buyer/seller is willing to cross
the bid-ask spread. If the buyer/seller places a large enough
order that consumes all available volume at the best price,
then the bid-ask spread changes, leading to a liquidity shock.
Such a shock is followed by a period during which partic-
ipants replenish the order book with new bid/ask orders.
Such limit orders that update the best bid/ask price are
referred to as quote events.

The rate of recovery or mean reversion of the spread and
mid-price is indicative of the market’s resiliency and is of
great importance to traders, exchanges and regulators. An
eﬃcient and accurate model for market resiliency can di-
rectly beneﬁt traders, allowing them to reduce market im-
pact costs by splitting large orders across time. Moreover,

∗PhD candidate, kasthana@stanford.edu
†PhD candidate, racolon@stanford.edu
‡PhD candidate, jdromero@stanford.edu

such a model can improve existing back-testing platforms for
trading strategies by including a feedback from the market.
The goal of this project is to develop an accurate model for
predicting the short-term response of the market to liquidity
shocks in the order book. In particular, we are interested
in forecasting values of the best bid and best ask prices for
ﬁfty time steps following an order that triggers a liquidity
shock. The input to our algorithm consists of information on
ﬁfty pre-shock transactions, the shock-causing transaction,
as well as macroscopic indicators regarding each security.
We then use variants of linear regression (LR) and support
vector regression (SVR) to predict increments in mid-price
and bid-ask spread for the ﬁfty time steps after the shock.

2 Related work

Numerous stochastic models have been proposed for the
state of a limit order book. These include static models [1]
where the trader’s choice to place limit or market orders is
made exogenously, as well as dynamic models [2] that make
such a choice internally by factoring waiting costs. It has
been shown [3] that liquidity shocks temporarily increase
the bid-ask spread which reverts to a competitive level as
new orders arrive. We empirically verify this observation in
Section 3.1. Dynamics of market resiliency have also been
studied in [4] where the authors show that the two prin-
cipal factors governing the rate of mean reversion are the
proportion of patient traders and rate of order arrival.

It is important to note that a liquidity shock in the limit
order book is a high frequency phenomenon wherein the
change in spread is on the order of a few ticks. It must be
contrasted with macroscopic shocks during ﬁnancial crises
wherein the bid-ask spread widens catastrophically imped-
ing traders from closing positions. Extensive investigations
have been conducted into the dynamics of macroscopic liq-
uidity across equity and bond markets [5], premia associated
with shocks in equilibrium markets [6], impact of macro-
scopic shocks on HFT participants [7], shocks due to federal
monetary policies [8] etc.

Linear
k-Nearest
Regress. Neighbors

0.778

0.786

0.796

SVR Random k-Means

Forest
0.797

0.798

Table 1: Relative performance (RMSE) of algorithms uti-
lized by a top-ranking kaggle.com competition participant.

This problem was part of a competition sponsored by the
Capital Markets Cooperative Research Centre, hosted on-

1

line at kaggle.com [9]. The competition ended in January
2012 and a discussion ensued wherein participants shared
performance of their algorithms on an undisclosed test set.
Table 1 shows the root mean squared error obtained from
six diﬀerent algorithms. The proximity of results indicates
that there is negligible predictive ability in the features! In
this report, we show how this observation can be veriﬁed,
explained and then circumvented.

that the expected mid and spread are given by
−αM (t−t0) + µM ,
−αS (t−t0) + µS,

E[Mt] = (Mt0 − µM )e
E[St] = (St0 − µS)e

(3)

where t0 = 49 is the time of incidence of the shock. The
exponential damping in time is a strong indicator of mean-
reversion and can be veriﬁed using the empirical estimators

3 Data and Benchmark

ˆE[Mt − Mt0] =

1
m

(Mt

(i) − Mt0

(i)),

m(cid:88)
m(cid:88)

i=1

i=1

Trade and quote (TAQ) data for 110,000 examples of liquid-
ity shocks across several securities and trading times were
obtained directly from the competition website. Each exam-
ple includes information on 50 transactions leading to the
shock and an equal number after the shock. All prices are
measured in units of pence. For pre-shock transactions, the
data provides (i) nature (trade/quote), (ii) time, (iii) best
bid price, and (iv) best ask price for each transaction. Re-
garding the shock itself, we are provided (i) volume-weighted
average price, (ii) volume, and (iii) nature (buy/sell initi-
ated) of the trade causing the liquidity shock. Addition-
ally, we are also provided (i) the number of previous day
on-market trades, and (ii) sum of previous day on-market
trade values. For post-shock transactions, only data on bid
and ask prices is available.

Of the total data, 80,000 examples were randomly chosen
to form the training set, 20,000 were held out for optimizing
parameters in SVR and the remaining 10,000 were desig-
nated as the test set.

3.1 Mean-reversion of mid and spread

Prior to exploring learning algorithms, we begin with a sta-
tistical characterization of the provided high-frequency data
to verify the observations in [3]. Denoting Bt, At as the
best bid and ask prices for a given time t, the mid price and
bid-ask spread are respectively deﬁned as

Mt =

At + Bt

2

, St = At − Bt.

(1)

For liquid securities, both the mid-price and spread are of-
ten assumed to be mean reverting over short time horizons,
i.e. they have a tendency to return to some non-observable
mean levels. The time series for both quantities can then be
represented by Ornstein-Uhlenbeck (OU) processes [10],

,

t

dMt = αM (µM − Mt)dt + σM dBM
dSt = αS(µS − St)dt + σSdBS
t ,
where BM
, BS
t are standard Brownian motions, σM , σS
t
are the respective volatilities, µM , µS are the mean levels,
and the critical quantities αM , αS are the rates of mean
reversion. The two processes are correlated Cov(BM
t ) =
t
ρt. Owing to linearity in the diﬀusion term, one can show

, BS

(2)

2

ˆE[St − St0] =

1
m

(St

(i) − St0

(i)),

(4)

as a function of time, where m denotes the number of ex-
amples. The post-shock values of these quantities for the
training set are plotted in Fig. 1. A distinction is made
between buy-initiated and sell-initiated shocks as they in-
ﬂuence the mid-price in opposite directions. We see that
both the mid-price and bid-ask spread exhibit strong mean
reversion.
In the case of a buy-initiated shock, the mean
level is higher than than the value prior to the shock, i.e.
the shock increases the long-term or macro level price of
the security. The corresponding decrease happens for a sell-
initiated stock. This phenomenon captures the basic process
by which securities change in value over time. The mean
level for the spread is slightly higher than the pre-shock
level. This highlights the impact of the shock in reducing
liquidity of the security.

Figure 1: Mean reversion of mid-price and bid-ask spread

3.2 Benchmark

We use the statistical estimators in Eqn. (4) as our bench-
mark algorithm,

ˆMt = Mt0 + ˆE[Mt − Mt0],
ˆBt = ˆMt − ˆSt/2,

ˆAt = ˆMt + ˆSt/2,

ˆSt = St0 + ˆE[St − St0 ],

(5)

2468101214−0.5−0.4−0.3−0.2−0.100.10.20.30.40.5t−t0ˆE[Mt−Mt0],ˆE[St−St0]  mid−price − buy−initmid−price − sell−initspreadwhere ˆBt, ˆAt are the predicted values. This corresponds to
a linear mean model consisting of only the intercept term
and no features. As dictated by the competition organizers,
accuracy is measured in terms of the root mean square error
across the entire set,

log(RMSE(i)), i =
Figure 2 records the histogram of
1, . . . , m. We see that the data has a relatively fat right
tail with a few isolated errors as large as 45 pence! The
extreme values are outliers generated by trading events at
the beginning of a day’s trading [9]. However, the smooth
part of the right tail is due to the fact that higher priced
securities have higher volatilities (see Section 5). This was
also observed in [5] where the authors suggested that past
volatility is a strong indicator of liquidity. Performance of
the benchmark is recorded in Table 3.

(cid:34)
(cid:34)

RMSE(i) =

RMSE =

t0+50(cid:88)
RMSE(i)(cid:17)2
(cid:16)
m(cid:88)

(B(i)

t=t0+1

(cid:35)1/2
t − ˆB(i)

,

1
100

1
m

i=1

t )2 + (A(i)

t − ˆA(i)
t )2

(cid:35)1/2

,

(6)

4.1 Coeﬃcient of determination

The eﬀect of incorporating linear feature-terms can be quan-
tiﬁed by measuring the fraction of the response’s variance
that is explained by the features. This is expressed by the
coeﬃcient of determination [11],

R2 = 1 −

SSres
SStot

=

SSreg
SStot

,

(7)

Figure 3 plots this statistic against the 50 post-shock re-
sponse variables for each of the three types of responses.
We see that for t − t0 > 2, the linear model captures less
than 10% of the variance in the response. In other words,
high frequency market ﬂuctuations (increments in mid or
spread) are essentially indiﬀerent to the type of security or
pre-shock transaction history. The linear model merely cap-
tures the mean behavior expressed by the benchmark. This
explains why top participants in the competition failed to
improve on the performance from linear regression despite
trying non-linear supervised and unsupervised learning al-
gorithms. Note that the response right after the shock has
R2 = 1; this is a consequence of repetition in the data sup-
plied by the problem organizers.

Figure 2: Histogram of log(RMSE(i)) for the benchmark.

Figure 3: R2 for the 50 post-shock variables

4 Linear Regression & Diagnostics

The simplest extension of the benchmark algorithm is to in-
corporate ﬁrst order terms of available features in the mean
model. This can be achieved by regressing linearly onto
all 206 available features (pre-shock transactions, at shock
transaction and security speciﬁc scalars). Three sets of mod-
els are trained to predict the ﬁfty discrete post-shock values
of (i) mid-price for a buy-initiated shock, (ii) mid-price for
a sell-initiated shock, and (iii) spread. Extensive analysis is
performed to determine the bias/variance trade-oﬀ of this
simple approach, and to measure the predictive ability of
the feature set.

4.2 Non-normality of residuals

Linear regression is formulated under the assumption that
the response is distributed normally about the mean model.
We can test this assumption by plotting the empirical quan-
tiles of the regression residuals against the quantiles of a
normal distribution with zero mean and variance equal to
the empirical variance of the residuals. Figure 4 records the
QQ plot of the spread-residual at t − t0 = 2. We see that
the data is exceptionally fat-tailed with the largest values
greater then 10 pence!. This is in line with the observations
in Section 3.2.

3

−3−2−101234050100150200250log(RMSE)Count0102030405000.10.20.30.40.50.60.70.80.91t−t0R−squared  mid−price − buy−initmid−price − sell−initspreadMarket Response to Liquidity Shocks in the Limit Order Book

Kartikey Asthana∗,

Roberto A. Col´on Qui˜nones†,

Joshua Romero‡

Stanford University, CS229 Machine Learning, Autumn 2015

Abstract

This report provides empirical evidence that the bid-ask
spread and mid-price exhibit strong mean reversion follow-
ing a liquidity shock in the limit order book. The mean
behavior of buy/sell initiated shocks is to increase/decrease
the macroscopic mid-price of the security. Linear as well
as non-linear models are trained to incorporate pre-shock
information for predicting post-shock behavior. However,
the features tend to add very little predictive power be-
yond the statistical mean behavior. We show that this is
largely on account of high volatility associated with high
priced securities. Deﬁning a measure of error which is nor-
malized by volatility indicates that features do have some
intrinsic predictive capability. In this new measure, linear
regression, weighted to account for heteroskedasticity, out-
performs SVR yielding an eﬃcient prediction algorithm for
high frequency data.

1

Introduction

Exchange-traded ﬁnancial instruments often incorporate a
transparent buyer-seller matching system known as a cen-
tral limit order book. For each security, this book maintains
a real-time record of bid/ask prices and volumes that market
participants are willing to trade at. The diﬀerence between
the highest bid and lowest ask price is referred to as the
bid-ask spread and is typically narrow for actively traded
securities. This spread is a quantitative measure of the se-
curity’s liquidity since a narrow spread implies a smaller
premium to be paid for buying/selling and vice-versa.

A trade is executed when a buyer/seller is willing to cross
the bid-ask spread. If the buyer/seller places a large enough
order that consumes all available volume at the best price,
then the bid-ask spread changes, leading to a liquidity shock.
Such a shock is followed by a period during which partic-
ipants replenish the order book with new bid/ask orders.
Such limit orders that update the best bid/ask price are
referred to as quote events.

The rate of recovery or mean reversion of the spread and
mid-price is indicative of the market’s resiliency and is of
great importance to traders, exchanges and regulators. An
eﬃcient and accurate model for market resiliency can di-
rectly beneﬁt traders, allowing them to reduce market im-
pact costs by splitting large orders across time. Moreover,

∗PhD candidate, kasthana@stanford.edu
†PhD candidate, racolon@stanford.edu
‡PhD candidate, jdromero@stanford.edu

such a model can improve existing back-testing platforms for
trading strategies by including a feedback from the market.
The goal of this project is to develop an accurate model for
predicting the short-term response of the market to liquidity
shocks in the order book. In particular, we are interested
in forecasting values of the best bid and best ask prices for
ﬁfty time steps following an order that triggers a liquidity
shock. The input to our algorithm consists of information on
ﬁfty pre-shock transactions, the shock-causing transaction,
as well as macroscopic indicators regarding each security.
We then use variants of linear regression (LR) and support
vector regression (SVR) to predict increments in mid-price
and bid-ask spread for the ﬁfty time steps after the shock.

2 Related work

Numerous stochastic models have been proposed for the
state of a limit order book. These include static models [1]
where the trader’s choice to place limit or market orders is
made exogenously, as well as dynamic models [2] that make
such a choice internally by factoring waiting costs. It has
been shown [3] that liquidity shocks temporarily increase
the bid-ask spread which reverts to a competitive level as
new orders arrive. We empirically verify this observation in
Section 3.1. Dynamics of market resiliency have also been
studied in [4] where the authors show that the two prin-
cipal factors governing the rate of mean reversion are the
proportion of patient traders and rate of order arrival.

It is important to note that a liquidity shock in the limit
order book is a high frequency phenomenon wherein the
change in spread is on the order of a few ticks. It must be
contrasted with macroscopic shocks during ﬁnancial crises
wherein the bid-ask spread widens catastrophically imped-
ing traders from closing positions. Extensive investigations
have been conducted into the dynamics of macroscopic liq-
uidity across equity and bond markets [5], premia associated
with shocks in equilibrium markets [6], impact of macro-
scopic shocks on HFT participants [7], shocks due to federal
monetary policies [8] etc.

Linear
k-Nearest
Regress. Neighbors

0.778

0.786

0.796

SVR Random k-Means

Forest
0.797

0.798

Table 1: Relative performance (RMSE) of algorithms uti-
lized by a top-ranking kaggle.com competition participant.

This problem was part of a competition sponsored by the
Capital Markets Cooperative Research Centre, hosted on-

1

line at kaggle.com [9]. The competition ended in January
2012 and a discussion ensued wherein participants shared
performance of their algorithms on an undisclosed test set.
Table 1 shows the root mean squared error obtained from
six diﬀerent algorithms. The proximity of results indicates
that there is negligible predictive ability in the features! In
this report, we show how this observation can be veriﬁed,
explained and then circumvented.

that the expected mid and spread are given by
−αM (t−t0) + µM ,
−αS (t−t0) + µS,

E[Mt] = (Mt0 − µM )e
E[St] = (St0 − µS)e

(3)

where t0 = 49 is the time of incidence of the shock. The
exponential damping in time is a strong indicator of mean-
reversion and can be veriﬁed using the empirical estimators

3 Data and Benchmark

ˆE[Mt − Mt0] =

1
m

(Mt

(i) − Mt0

(i)),

m(cid:88)
m(cid:88)

i=1

i=1

Trade and quote (TAQ) data for 110,000 examples of liquid-
ity shocks across several securities and trading times were
obtained directly from the competition website. Each exam-
ple includes information on 50 transactions leading to the
shock and an equal number after the shock. All prices are
measured in units of pence. For pre-shock transactions, the
data provides (i) nature (trade/quote), (ii) time, (iii) best
bid price, and (iv) best ask price for each transaction. Re-
garding the shock itself, we are provided (i) volume-weighted
average price, (ii) volume, and (iii) nature (buy/sell initi-
ated) of the trade causing the liquidity shock. Addition-
ally, we are also provided (i) the number of previous day
on-market trades, and (ii) sum of previous day on-market
trade values. For post-shock transactions, only data on bid
and ask prices is available.

Of the total data, 80,000 examples were randomly chosen
to form the training set, 20,000 were held out for optimizing
parameters in SVR and the remaining 10,000 were desig-
nated as the test set.

3.1 Mean-reversion of mid and spread

Prior to exploring learning algorithms, we begin with a sta-
tistical characterization of the provided high-frequency data
to verify the observations in [3]. Denoting Bt, At as the
best bid and ask prices for a given time t, the mid price and
bid-ask spread are respectively deﬁned as

Mt =

At + Bt

2

, St = At − Bt.

(1)

For liquid securities, both the mid-price and spread are of-
ten assumed to be mean reverting over short time horizons,
i.e. they have a tendency to return to some non-observable
mean levels. The time series for both quantities can then be
represented by Ornstein-Uhlenbeck (OU) processes [10],

,

t

dMt = αM (µM − Mt)dt + σM dBM
dSt = αS(µS − St)dt + σSdBS
t ,
where BM
, BS
t are standard Brownian motions, σM , σS
t
are the respective volatilities, µM , µS are the mean levels,
and the critical quantities αM , αS are the rates of mean
reversion. The two processes are correlated Cov(BM
t ) =
t
ρt. Owing to linearity in the diﬀusion term, one can show

, BS

(2)

2

ˆE[St − St0] =

1
m

(St

(i) − St0

(i)),

(4)

as a function of time, where m denotes the number of ex-
amples. The post-shock values of these quantities for the
training set are plotted in Fig. 1. A distinction is made
between buy-initiated and sell-initiated shocks as they in-
ﬂuence the mid-price in opposite directions. We see that
both the mid-price and bid-ask spread exhibit strong mean
reversion.
In the case of a buy-initiated shock, the mean
level is higher than than the value prior to the shock, i.e.
the shock increases the long-term or macro level price of
the security. The corresponding decrease happens for a sell-
initiated stock. This phenomenon captures the basic process
by which securities change in value over time. The mean
level for the spread is slightly higher than the pre-shock
level. This highlights the impact of the shock in reducing
liquidity of the security.

Figure 1: Mean reversion of mid-price and bid-ask spread

3.2 Benchmark

We use the statistical estimators in Eqn. (4) as our bench-
mark algorithm,

ˆMt = Mt0 + ˆE[Mt − Mt0],
ˆBt = ˆMt − ˆSt/2,

ˆAt = ˆMt + ˆSt/2,

ˆSt = St0 + ˆE[St − St0 ],

(5)

2468101214−0.5−0.4−0.3−0.2−0.100.10.20.30.40.5t−t0ˆE[Mt−Mt0],ˆE[St−St0]  mid−price − buy−initmid−price − sell−initspreadwhere ˆBt, ˆAt are the predicted values. This corresponds to
a linear mean model consisting of only the intercept term
and no features. As dictated by the competition organizers,
accuracy is measured in terms of the root mean square error
across the entire set,

log(RMSE(i)), i =
Figure 2 records the histogram of
1, . . . , m. We see that the data has a relatively fat right
tail with a few isolated errors as large as 45 pence! The
extreme values are outliers generated by trading events at
the beginning of a day’s trading [9]. However, the smooth
part of the right tail is due to the fact that higher priced
securities have higher volatilities (see Section 5). This was
also observed in [5] where the authors suggested that past
volatility is a strong indicator of liquidity. Performance of
the benchmark is recorded in Table 3.

(cid:34)
(cid:34)

RMSE(i) =

RMSE =

t0+50(cid:88)
RMSE(i)(cid:17)2
(cid:16)
m(cid:88)

(B(i)

t=t0+1

(cid:35)1/2
t − ˆB(i)

,

1
100

1
m

i=1

t )2 + (A(i)

t − ˆA(i)
t )2

(cid:35)1/2

,

(6)

4.1 Coeﬃcient of determination

The eﬀect of incorporating linear feature-terms can be quan-
tiﬁed by measuring the fraction of the response’s variance
that is explained by the features. This is expressed by the
coeﬃcient of determination [11],

R2 = 1 −

SSres
SStot

=

SSreg
SStot

,

(7)

Figure 3 plots this statistic against the 50 post-shock re-
sponse variables for each of the three types of responses.
We see that for t − t0 > 2, the linear model captures less
than 10% of the variance in the response. In other words,
high frequency market ﬂuctuations (increments in mid or
spread) are essentially indiﬀerent to the type of security or
pre-shock transaction history. The linear model merely cap-
tures the mean behavior expressed by the benchmark. This
explains why top participants in the competition failed to
improve on the performance from linear regression despite
trying non-linear supervised and unsupervised learning al-
gorithms. Note that the response right after the shock has
R2 = 1; this is a consequence of repetition in the data sup-
plied by the problem organizers.

Figure 2: Histogram of log(RMSE(i)) for the benchmark.

Figure 3: R2 for the 50 post-shock variables

4 Linear Regression & Diagnostics

The simplest extension of the benchmark algorithm is to in-
corporate ﬁrst order terms of available features in the mean
model. This can be achieved by regressing linearly onto
all 206 available features (pre-shock transactions, at shock
transaction and security speciﬁc scalars). Three sets of mod-
els are trained to predict the ﬁfty discrete post-shock values
of (i) mid-price for a buy-initiated shock, (ii) mid-price for
a sell-initiated shock, and (iii) spread. Extensive analysis is
performed to determine the bias/variance trade-oﬀ of this
simple approach, and to measure the predictive ability of
the feature set.

4.2 Non-normality of residuals

Linear regression is formulated under the assumption that
the response is distributed normally about the mean model.
We can test this assumption by plotting the empirical quan-
tiles of the regression residuals against the quantiles of a
normal distribution with zero mean and variance equal to
the empirical variance of the residuals. Figure 4 records the
QQ plot of the spread-residual at t − t0 = 2. We see that
the data is exceptionally fat-tailed with the largest values
greater then 10 pence!. This is in line with the observations
in Section 3.2.

3

−3−2−101234050100150200250log(RMSE)Count0102030405000.10.20.30.40.50.60.70.80.91t−t0R−squared  mid−price − buy−initmid−price − sell−initspreadFigure 4: QQ plot for Leave-One-Out Cross Validation

Figure 5: RMSE learning curve for linear regression

4.2.1 Leave-one-out CV

5 k-means Clustering

We can further verify the fat-tailed nature of the response
by performing leave-one-out cross validation for the linear
model and observing the change in prediction for the held-
out example,

−i
i = yi − ˆy
i

,

i = 1, 2, . . . , m,

(8)

where yi is the observed response for the ith example, and
−i
is the prediction for the ith example using all except the
ˆy
i
ith example. In the case of linear regression, a simpliﬁcation
can be achieved [11] using the Sherman-Morrison formula
that allows for an analytical expression of the form,

i =

ˆyi

1 − Hii

,

i = 1, 2, . . . , m,

(9)

where ˆyi is the prediction for the ith example using all m
examples and Hii is the leverage of the ith example. The
QQ plot of leave-one-out residuals is also recorded in Figure
4. Once again. the fat tails are evident. In section 5, we
show, empirically, that these fat-tails are largely on account
of heteroskedasticity, since diﬀerent securities have diﬀerent
inherent volatilities.

4.3 Learning curve

We have already seen that the entire set of 206 linear features
has very little prediction power beyond the benchmark for
most of the response variables. Figure 5 plots the learning
curve for RMSE (Eqn. (6)) where the test error is calculated
on the 20,000 examples in the held-out set mentioned in
Section 3. The plot shows that the linear model suﬀers from
high bias, with a rapid plateau of test error and increasing
training error. This indicates that either the current model
is not capturing nonlinear dependence on the features, or
that the overall RMSE is largely controlled by the outliers
mentioned in Section 4.2.1. In the upcoming sections, we
provide some evidence of the latter.

As mentioned in Sections 3.2 and 4.2.1, we claim that the
non-normality of the regression residuals is largely due to
diﬀerent variances for diﬀerent training examples. This
claim is motivated from the observation that price processes
are often modeled as geometric Brownian motions wherein
the volatility is proportional to the price, i.e. we expect
higher priced securities to have higher volatilities. In par-
ticular, from Eqn. (6),

RMSE2

bench (cid:39)

1
m

E

Var(B(i)

t ) + Var(A(i)
t )

,

(10)

(cid:104)

m(cid:88)

i=1

(cid:105)

which shows that each example contributes error propor-
tional to its variance. This can be empirically veriﬁed by
training separate models on clusters sorted by bid price.
Towards this end, we use k-means to identify 3 centroids in
the training data, train 3 sets of models, and record the cor-
responding RMSE values for clusters in the test set. Table
2 shows that RMSE grows with growing cluster price, con-
ﬁrming our claim. Hence, the RMSE for the full test set is
largely dictated by the proportion of high priced securities.

Centroid

RMSE
RMSFE

Clusters

£3.27
0.42p
0.33

£11.75
1.60p
0.34

£22.77
1.90p
0.34

Table 2: Clustering with 3-means based on bid price

In order to circumvent this limitation, we deﬁne an alter-

native metric, the Root Mean Square Fractional Error,

(cid:32)

t0+50(cid:88)

t=t0+1

1
100

B(i)
t − ˆB(i)

t

δ

(cid:33)2

(cid:32)

+

A(i)
t − ˆA(i)

t

δ

m(cid:88)

i=1

(11)

(cid:33)21/2

,

δ = max{max

t

Bt − min

t

Bt, max

t

At − min

t

At},

(12)

RMSFE

 1

m

=

4

−505−10−50510Standard Normal QuantilesQuantilesofresidual:ǫ(∆St0+2)  LR residualLOOCV resdiual00.20.40.60.811.21.41.61.82x 1040.40.60.811.21.41.61.822.22.4Number of samplesRoot Mean Square Error (RMSE)  Test ErrorTrain ErrorMarket Response to Liquidity Shocks in the Limit Order Book

Kartikey Asthana∗,

Roberto A. Col´on Qui˜nones†,

Joshua Romero‡

Stanford University, CS229 Machine Learning, Autumn 2015

Abstract

This report provides empirical evidence that the bid-ask
spread and mid-price exhibit strong mean reversion follow-
ing a liquidity shock in the limit order book. The mean
behavior of buy/sell initiated shocks is to increase/decrease
the macroscopic mid-price of the security. Linear as well
as non-linear models are trained to incorporate pre-shock
information for predicting post-shock behavior. However,
the features tend to add very little predictive power be-
yond the statistical mean behavior. We show that this is
largely on account of high volatility associated with high
priced securities. Deﬁning a measure of error which is nor-
malized by volatility indicates that features do have some
intrinsic predictive capability. In this new measure, linear
regression, weighted to account for heteroskedasticity, out-
performs SVR yielding an eﬃcient prediction algorithm for
high frequency data.

1

Introduction

Exchange-traded ﬁnancial instruments often incorporate a
transparent buyer-seller matching system known as a cen-
tral limit order book. For each security, this book maintains
a real-time record of bid/ask prices and volumes that market
participants are willing to trade at. The diﬀerence between
the highest bid and lowest ask price is referred to as the
bid-ask spread and is typically narrow for actively traded
securities. This spread is a quantitative measure of the se-
curity’s liquidity since a narrow spread implies a smaller
premium to be paid for buying/selling and vice-versa.

A trade is executed when a buyer/seller is willing to cross
the bid-ask spread. If the buyer/seller places a large enough
order that consumes all available volume at the best price,
then the bid-ask spread changes, leading to a liquidity shock.
Such a shock is followed by a period during which partic-
ipants replenish the order book with new bid/ask orders.
Such limit orders that update the best bid/ask price are
referred to as quote events.

The rate of recovery or mean reversion of the spread and
mid-price is indicative of the market’s resiliency and is of
great importance to traders, exchanges and regulators. An
eﬃcient and accurate model for market resiliency can di-
rectly beneﬁt traders, allowing them to reduce market im-
pact costs by splitting large orders across time. Moreover,

∗PhD candidate, kasthana@stanford.edu
†PhD candidate, racolon@stanford.edu
‡PhD candidate, jdromero@stanford.edu

such a model can improve existing back-testing platforms for
trading strategies by including a feedback from the market.
The goal of this project is to develop an accurate model for
predicting the short-term response of the market to liquidity
shocks in the order book. In particular, we are interested
in forecasting values of the best bid and best ask prices for
ﬁfty time steps following an order that triggers a liquidity
shock. The input to our algorithm consists of information on
ﬁfty pre-shock transactions, the shock-causing transaction,
as well as macroscopic indicators regarding each security.
We then use variants of linear regression (LR) and support
vector regression (SVR) to predict increments in mid-price
and bid-ask spread for the ﬁfty time steps after the shock.

2 Related work

Numerous stochastic models have been proposed for the
state of a limit order book. These include static models [1]
where the trader’s choice to place limit or market orders is
made exogenously, as well as dynamic models [2] that make
such a choice internally by factoring waiting costs. It has
been shown [3] that liquidity shocks temporarily increase
the bid-ask spread which reverts to a competitive level as
new orders arrive. We empirically verify this observation in
Section 3.1. Dynamics of market resiliency have also been
studied in [4] where the authors show that the two prin-
cipal factors governing the rate of mean reversion are the
proportion of patient traders and rate of order arrival.

It is important to note that a liquidity shock in the limit
order book is a high frequency phenomenon wherein the
change in spread is on the order of a few ticks. It must be
contrasted with macroscopic shocks during ﬁnancial crises
wherein the bid-ask spread widens catastrophically imped-
ing traders from closing positions. Extensive investigations
have been conducted into the dynamics of macroscopic liq-
uidity across equity and bond markets [5], premia associated
with shocks in equilibrium markets [6], impact of macro-
scopic shocks on HFT participants [7], shocks due to federal
monetary policies [8] etc.

Linear
k-Nearest
Regress. Neighbors

0.778

0.786

0.796

SVR Random k-Means

Forest
0.797

0.798

Table 1: Relative performance (RMSE) of algorithms uti-
lized by a top-ranking kaggle.com competition participant.

This problem was part of a competition sponsored by the
Capital Markets Cooperative Research Centre, hosted on-

1

line at kaggle.com [9]. The competition ended in January
2012 and a discussion ensued wherein participants shared
performance of their algorithms on an undisclosed test set.
Table 1 shows the root mean squared error obtained from
six diﬀerent algorithms. The proximity of results indicates
that there is negligible predictive ability in the features! In
this report, we show how this observation can be veriﬁed,
explained and then circumvented.

that the expected mid and spread are given by
−αM (t−t0) + µM ,
−αS (t−t0) + µS,

E[Mt] = (Mt0 − µM )e
E[St] = (St0 − µS)e

(3)

where t0 = 49 is the time of incidence of the shock. The
exponential damping in time is a strong indicator of mean-
reversion and can be veriﬁed using the empirical estimators

3 Data and Benchmark

ˆE[Mt − Mt0] =

1
m

(Mt

(i) − Mt0

(i)),

m(cid:88)
m(cid:88)

i=1

i=1

Trade and quote (TAQ) data for 110,000 examples of liquid-
ity shocks across several securities and trading times were
obtained directly from the competition website. Each exam-
ple includes information on 50 transactions leading to the
shock and an equal number after the shock. All prices are
measured in units of pence. For pre-shock transactions, the
data provides (i) nature (trade/quote), (ii) time, (iii) best
bid price, and (iv) best ask price for each transaction. Re-
garding the shock itself, we are provided (i) volume-weighted
average price, (ii) volume, and (iii) nature (buy/sell initi-
ated) of the trade causing the liquidity shock. Addition-
ally, we are also provided (i) the number of previous day
on-market trades, and (ii) sum of previous day on-market
trade values. For post-shock transactions, only data on bid
and ask prices is available.

Of the total data, 80,000 examples were randomly chosen
to form the training set, 20,000 were held out for optimizing
parameters in SVR and the remaining 10,000 were desig-
nated as the test set.

3.1 Mean-reversion of mid and spread

Prior to exploring learning algorithms, we begin with a sta-
tistical characterization of the provided high-frequency data
to verify the observations in [3]. Denoting Bt, At as the
best bid and ask prices for a given time t, the mid price and
bid-ask spread are respectively deﬁned as

Mt =

At + Bt

2

, St = At − Bt.

(1)

For liquid securities, both the mid-price and spread are of-
ten assumed to be mean reverting over short time horizons,
i.e. they have a tendency to return to some non-observable
mean levels. The time series for both quantities can then be
represented by Ornstein-Uhlenbeck (OU) processes [10],

,

t

dMt = αM (µM − Mt)dt + σM dBM
dSt = αS(µS − St)dt + σSdBS
t ,
where BM
, BS
t are standard Brownian motions, σM , σS
t
are the respective volatilities, µM , µS are the mean levels,
and the critical quantities αM , αS are the rates of mean
reversion. The two processes are correlated Cov(BM
t ) =
t
ρt. Owing to linearity in the diﬀusion term, one can show

, BS

(2)

2

ˆE[St − St0] =

1
m

(St

(i) − St0

(i)),

(4)

as a function of time, where m denotes the number of ex-
amples. The post-shock values of these quantities for the
training set are plotted in Fig. 1. A distinction is made
between buy-initiated and sell-initiated shocks as they in-
ﬂuence the mid-price in opposite directions. We see that
both the mid-price and bid-ask spread exhibit strong mean
reversion.
In the case of a buy-initiated shock, the mean
level is higher than than the value prior to the shock, i.e.
the shock increases the long-term or macro level price of
the security. The corresponding decrease happens for a sell-
initiated stock. This phenomenon captures the basic process
by which securities change in value over time. The mean
level for the spread is slightly higher than the pre-shock
level. This highlights the impact of the shock in reducing
liquidity of the security.

Figure 1: Mean reversion of mid-price and bid-ask spread

3.2 Benchmark

We use the statistical estimators in Eqn. (4) as our bench-
mark algorithm,

ˆMt = Mt0 + ˆE[Mt − Mt0],
ˆBt = ˆMt − ˆSt/2,

ˆAt = ˆMt + ˆSt/2,

ˆSt = St0 + ˆE[St − St0 ],

(5)

2468101214−0.5−0.4−0.3−0.2−0.100.10.20.30.40.5t−t0ˆE[Mt−Mt0],ˆE[St−St0]  mid−price − buy−initmid−price − sell−initspreadwhere ˆBt, ˆAt are the predicted values. This corresponds to
a linear mean model consisting of only the intercept term
and no features. As dictated by the competition organizers,
accuracy is measured in terms of the root mean square error
across the entire set,

log(RMSE(i)), i =
Figure 2 records the histogram of
1, . . . , m. We see that the data has a relatively fat right
tail with a few isolated errors as large as 45 pence! The
extreme values are outliers generated by trading events at
the beginning of a day’s trading [9]. However, the smooth
part of the right tail is due to the fact that higher priced
securities have higher volatilities (see Section 5). This was
also observed in [5] where the authors suggested that past
volatility is a strong indicator of liquidity. Performance of
the benchmark is recorded in Table 3.

(cid:34)
(cid:34)

RMSE(i) =

RMSE =

t0+50(cid:88)
RMSE(i)(cid:17)2
(cid:16)
m(cid:88)

(B(i)

t=t0+1

(cid:35)1/2
t − ˆB(i)

,

1
100

1
m

i=1

t )2 + (A(i)

t − ˆA(i)
t )2

(cid:35)1/2

,

(6)

4.1 Coeﬃcient of determination

The eﬀect of incorporating linear feature-terms can be quan-
tiﬁed by measuring the fraction of the response’s variance
that is explained by the features. This is expressed by the
coeﬃcient of determination [11],

R2 = 1 −

SSres
SStot

=

SSreg
SStot

,

(7)

Figure 3 plots this statistic against the 50 post-shock re-
sponse variables for each of the three types of responses.
We see that for t − t0 > 2, the linear model captures less
than 10% of the variance in the response. In other words,
high frequency market ﬂuctuations (increments in mid or
spread) are essentially indiﬀerent to the type of security or
pre-shock transaction history. The linear model merely cap-
tures the mean behavior expressed by the benchmark. This
explains why top participants in the competition failed to
improve on the performance from linear regression despite
trying non-linear supervised and unsupervised learning al-
gorithms. Note that the response right after the shock has
R2 = 1; this is a consequence of repetition in the data sup-
plied by the problem organizers.

Figure 2: Histogram of log(RMSE(i)) for the benchmark.

Figure 3: R2 for the 50 post-shock variables

4 Linear Regression & Diagnostics

The simplest extension of the benchmark algorithm is to in-
corporate ﬁrst order terms of available features in the mean
model. This can be achieved by regressing linearly onto
all 206 available features (pre-shock transactions, at shock
transaction and security speciﬁc scalars). Three sets of mod-
els are trained to predict the ﬁfty discrete post-shock values
of (i) mid-price for a buy-initiated shock, (ii) mid-price for
a sell-initiated shock, and (iii) spread. Extensive analysis is
performed to determine the bias/variance trade-oﬀ of this
simple approach, and to measure the predictive ability of
the feature set.

4.2 Non-normality of residuals

Linear regression is formulated under the assumption that
the response is distributed normally about the mean model.
We can test this assumption by plotting the empirical quan-
tiles of the regression residuals against the quantiles of a
normal distribution with zero mean and variance equal to
the empirical variance of the residuals. Figure 4 records the
QQ plot of the spread-residual at t − t0 = 2. We see that
the data is exceptionally fat-tailed with the largest values
greater then 10 pence!. This is in line with the observations
in Section 3.2.

3

−3−2−101234050100150200250log(RMSE)Count0102030405000.10.20.30.40.50.60.70.80.91t−t0R−squared  mid−price − buy−initmid−price − sell−initspreadFigure 4: QQ plot for Leave-One-Out Cross Validation

Figure 5: RMSE learning curve for linear regression

4.2.1 Leave-one-out CV

5 k-means Clustering

We can further verify the fat-tailed nature of the response
by performing leave-one-out cross validation for the linear
model and observing the change in prediction for the held-
out example,

−i
i = yi − ˆy
i

,

i = 1, 2, . . . , m,

(8)

where yi is the observed response for the ith example, and
−i
is the prediction for the ith example using all except the
ˆy
i
ith example. In the case of linear regression, a simpliﬁcation
can be achieved [11] using the Sherman-Morrison formula
that allows for an analytical expression of the form,

i =

ˆyi

1 − Hii

,

i = 1, 2, . . . , m,

(9)

where ˆyi is the prediction for the ith example using all m
examples and Hii is the leverage of the ith example. The
QQ plot of leave-one-out residuals is also recorded in Figure
4. Once again. the fat tails are evident. In section 5, we
show, empirically, that these fat-tails are largely on account
of heteroskedasticity, since diﬀerent securities have diﬀerent
inherent volatilities.

4.3 Learning curve

We have already seen that the entire set of 206 linear features
has very little prediction power beyond the benchmark for
most of the response variables. Figure 5 plots the learning
curve for RMSE (Eqn. (6)) where the test error is calculated
on the 20,000 examples in the held-out set mentioned in
Section 3. The plot shows that the linear model suﬀers from
high bias, with a rapid plateau of test error and increasing
training error. This indicates that either the current model
is not capturing nonlinear dependence on the features, or
that the overall RMSE is largely controlled by the outliers
mentioned in Section 4.2.1. In the upcoming sections, we
provide some evidence of the latter.

As mentioned in Sections 3.2 and 4.2.1, we claim that the
non-normality of the regression residuals is largely due to
diﬀerent variances for diﬀerent training examples. This
claim is motivated from the observation that price processes
are often modeled as geometric Brownian motions wherein
the volatility is proportional to the price, i.e. we expect
higher priced securities to have higher volatilities. In par-
ticular, from Eqn. (6),

RMSE2

bench (cid:39)

1
m

E

Var(B(i)

t ) + Var(A(i)
t )

,

(10)

(cid:104)

m(cid:88)

i=1

(cid:105)

which shows that each example contributes error propor-
tional to its variance. This can be empirically veriﬁed by
training separate models on clusters sorted by bid price.
Towards this end, we use k-means to identify 3 centroids in
the training data, train 3 sets of models, and record the cor-
responding RMSE values for clusters in the test set. Table
2 shows that RMSE grows with growing cluster price, con-
ﬁrming our claim. Hence, the RMSE for the full test set is
largely dictated by the proportion of high priced securities.

Centroid

RMSE
RMSFE

Clusters

£3.27
0.42p
0.33

£11.75
1.60p
0.34

£22.77
1.90p
0.34

Table 2: Clustering with 3-means based on bid price

In order to circumvent this limitation, we deﬁne an alter-

native metric, the Root Mean Square Fractional Error,

(cid:32)

t0+50(cid:88)

t=t0+1

1
100

B(i)
t − ˆB(i)

t

δ

(cid:33)2

(cid:32)

+

A(i)
t − ˆA(i)

t

δ

m(cid:88)

i=1

(11)

(cid:33)21/2

,

δ = max{max

t

Bt − min

t

Bt, max

t

At − min

t

At},

(12)

RMSFE

 1

m

=

4

−505−10−50510Standard Normal QuantilesQuantilesofresidual:ǫ(∆St0+2)  LR residualLOOCV resdiual00.20.40.60.811.21.41.61.82x 1040.40.60.811.21.41.61.822.22.4Number of samplesRoot Mean Square Error (RMSE)  Test ErrorTrain Errorwhich measures the fraction of volatility of the response that
is explained by the learning algorithm. Table 2 shows that
RMSFE remains nearly constant across the clusters as de-
sired.

6 Weighted LR: heteroskedasticity

The empirical observations from the previous section show
that the normality assumption in vanilla linear regression
is clearly violated. An improvement can be readily incor-
porated by estimating the volatility of each example from
pre-shock prices,

t0(cid:88)
t0(cid:88)

t=1

2

σ(i)
M

(cid:39) (ˆσ(i)

M )2 =

2

σ(i)
S

(cid:39) (ˆσ(i)

S )2 =

1

t0 − 1

1

t0 − 1

t=1

(M (i)

t − ¯M (i))2,

(S(i)

t − ¯S(i))2,

(13)

These diﬀering volatilities can be accommodated in the re-
gression by weighting the examples inversely by their vari-
ances. In particular,

S(i)
t =

θjz(i)

j + (i)
S ,

i = 1, . . . , M, t > t0

(cid:88)
(cid:16)

j

2(cid:17)

(i)
S ∼ N

0, σ(i)
S

Figure 6: ν-SVR : RMSE/RMSFE on a grid of (C,γ).

achieved by calculating errors over the 50 response variables
for a grid of parameter values. For computational ease, ν
is ﬁxed at 1/2. As the training set is massive and for each
point 50 models must be trained, we perform this grid search
using a small training set of 5,000 examples cross validated
against a held-out set of 1,000 samples. The contour plot
for both RMSE and RMSFE is recorded in Fig. 6. We see
that the smallest generalization error is obtained for very
small values of γ in the RBF kernel, i.e. the optimal model
is essentially linear in the features.

Limited by computational expense, we use optimal values
from Fig. 6 and train on the held-out set containing 20,000
samples, instead of the full training set.

,

(14)

8 Performance and Conclusion

where zj, j = 1, . . . , 206 denote the features. Denoting
−2
S i,j = (1/σ(i)
Σ
tors, the normal equations for this case are given by

)1i=j and using boldface for denote vec-

S

2

ZT Σ

−2
S Zθ = ZT Σ

−2
S St.

(15)

Such a weighted linear regression results in signiﬁcant im-
provement of the RMSFE (see Table 3) while the RMSE
remains roughly the same, as expected.

7 Support Vector Regression

In this section we show that the lack of ﬁt for linear re-
gression is not due to a non-linear interrelation between the
response and features. This further builds upon the discus-
sion from Section 4.3. Towards this end, we use LIBSVM
[12] to train a non-linear regression model based on ν-SVR,

min

w,b,ξ(cid:23)0,ξ∗(cid:23)0,≥0

1
2

wT w + Cν +

1T (ξ + ξ∗

),

C
l

s.t. wT φ(zi) + b − yi ≤  + ξi,
∗
− wT φ(zi) − b + yi ≤  + ξ
i ,

i = 1, . . . , m,
(16)

where z is the vector of features, y is the response and C, ν
are regularization parameters. We choose the radial basis
function as our kernel for the inner product,

< φ(z1), φ(z2) >= exp(cid:0)

−γ(cid:107)z1 − z2(cid:107)2

2

(17)

(cid:1) .

As directed by the authors in [13], we begin by determin-
ing reasonable choices for the parameters C and γ. This is

5

Algorithm
Benchmark
Linear Regression
Weighted LR
SVR

Train

Test

RMSE RMSFE RMSE RMSFE

1.41
1.26
1.36
—

2.23
0.51
0.35
—

1.23
1.16
1.20
1.19

1.26
0.40
0.34
0.45

Table 3: Comparative performance of the algorithms.

Table 3 records the training and testing RMSE (Eqn. (6))
and RMSFE (Eqn. (11)) for the four algorithms described
in the previous sections. The results for RMSE are similar
to those obtained by top kaggle-competition participants in
Table 1. Note that the actual values diﬀer since the test sets
are diﬀerent (the competition test set was not made public).
All algorithms produce RMSE values very close to that of
the benchmark showing that learning based on pre-shock
data was not beneﬁcial for RMSE. However, for the frac-
tional error, RMSFE, learning algorithms provide signiﬁcant
improvement over the benchmark. Among the three super-
vised learning models, weighted LR performs best, yielding
an eﬃcient prediction algorithm for high frequency data.

The table strongly supports the claims made in Sections
4.1, 5 and 7. The RMSE of the test set is largely dic-
tated by high priced securities associated with high volatil-
ity. Thus, adding linear/non-linear features adds very little
predictive capability in comparison to the benchmark. How-
ever, RMSFE, which normalizes error by volatility, indeed
decreases as the algorithm is reﬁned, showing that the fea-
tures do have some intrinsic predictive capability in this new
measure.

log2(Cost)log2(Gamma)  −5−4−3−2−10123−10−8−6−4−202RMSE1.061.081.11.121.141.161.18log2(Cost)log2(Gamma)  −5−4−3−2−10123−10−8−6−4−202RMSFE0.811.21.41.61.822.22.42.6Market Response to Liquidity Shocks in the Limit Order Book

Kartikey Asthana∗,

Roberto A. Col´on Qui˜nones†,

Joshua Romero‡

Stanford University, CS229 Machine Learning, Autumn 2015

Abstract

This report provides empirical evidence that the bid-ask
spread and mid-price exhibit strong mean reversion follow-
ing a liquidity shock in the limit order book. The mean
behavior of buy/sell initiated shocks is to increase/decrease
the macroscopic mid-price of the security. Linear as well
as non-linear models are trained to incorporate pre-shock
information for predicting post-shock behavior. However,
the features tend to add very little predictive power be-
yond the statistical mean behavior. We show that this is
largely on account of high volatility associated with high
priced securities. Deﬁning a measure of error which is nor-
malized by volatility indicates that features do have some
intrinsic predictive capability. In this new measure, linear
regression, weighted to account for heteroskedasticity, out-
performs SVR yielding an eﬃcient prediction algorithm for
high frequency data.

1

Introduction

Exchange-traded ﬁnancial instruments often incorporate a
transparent buyer-seller matching system known as a cen-
tral limit order book. For each security, this book maintains
a real-time record of bid/ask prices and volumes that market
participants are willing to trade at. The diﬀerence between
the highest bid and lowest ask price is referred to as the
bid-ask spread and is typically narrow for actively traded
securities. This spread is a quantitative measure of the se-
curity’s liquidity since a narrow spread implies a smaller
premium to be paid for buying/selling and vice-versa.

A trade is executed when a buyer/seller is willing to cross
the bid-ask spread. If the buyer/seller places a large enough
order that consumes all available volume at the best price,
then the bid-ask spread changes, leading to a liquidity shock.
Such a shock is followed by a period during which partic-
ipants replenish the order book with new bid/ask orders.
Such limit orders that update the best bid/ask price are
referred to as quote events.

The rate of recovery or mean reversion of the spread and
mid-price is indicative of the market’s resiliency and is of
great importance to traders, exchanges and regulators. An
eﬃcient and accurate model for market resiliency can di-
rectly beneﬁt traders, allowing them to reduce market im-
pact costs by splitting large orders across time. Moreover,

∗PhD candidate, kasthana@stanford.edu
†PhD candidate, racolon@stanford.edu
‡PhD candidate, jdromero@stanford.edu

such a model can improve existing back-testing platforms for
trading strategies by including a feedback from the market.
The goal of this project is to develop an accurate model for
predicting the short-term response of the market to liquidity
shocks in the order book. In particular, we are interested
in forecasting values of the best bid and best ask prices for
ﬁfty time steps following an order that triggers a liquidity
shock. The input to our algorithm consists of information on
ﬁfty pre-shock transactions, the shock-causing transaction,
as well as macroscopic indicators regarding each security.
We then use variants of linear regression (LR) and support
vector regression (SVR) to predict increments in mid-price
and bid-ask spread for the ﬁfty time steps after the shock.

2 Related work

Numerous stochastic models have been proposed for the
state of a limit order book. These include static models [1]
where the trader’s choice to place limit or market orders is
made exogenously, as well as dynamic models [2] that make
such a choice internally by factoring waiting costs. It has
been shown [3] that liquidity shocks temporarily increase
the bid-ask spread which reverts to a competitive level as
new orders arrive. We empirically verify this observation in
Section 3.1. Dynamics of market resiliency have also been
studied in [4] where the authors show that the two prin-
cipal factors governing the rate of mean reversion are the
proportion of patient traders and rate of order arrival.

It is important to note that a liquidity shock in the limit
order book is a high frequency phenomenon wherein the
change in spread is on the order of a few ticks. It must be
contrasted with macroscopic shocks during ﬁnancial crises
wherein the bid-ask spread widens catastrophically imped-
ing traders from closing positions. Extensive investigations
have been conducted into the dynamics of macroscopic liq-
uidity across equity and bond markets [5], premia associated
with shocks in equilibrium markets [6], impact of macro-
scopic shocks on HFT participants [7], shocks due to federal
monetary policies [8] etc.

Linear
k-Nearest
Regress. Neighbors

0.778

0.786

0.796

SVR Random k-Means

Forest
0.797

0.798

Table 1: Relative performance (RMSE) of algorithms uti-
lized by a top-ranking kaggle.com competition participant.

This problem was part of a competition sponsored by the
Capital Markets Cooperative Research Centre, hosted on-

1

line at kaggle.com [9]. The competition ended in January
2012 and a discussion ensued wherein participants shared
performance of their algorithms on an undisclosed test set.
Table 1 shows the root mean squared error obtained from
six diﬀerent algorithms. The proximity of results indicates
that there is negligible predictive ability in the features! In
this report, we show how this observation can be veriﬁed,
explained and then circumvented.

that the expected mid and spread are given by
−αM (t−t0) + µM ,
−αS (t−t0) + µS,

E[Mt] = (Mt0 − µM )e
E[St] = (St0 − µS)e

(3)

where t0 = 49 is the time of incidence of the shock. The
exponential damping in time is a strong indicator of mean-
reversion and can be veriﬁed using the empirical estimators

3 Data and Benchmark

ˆE[Mt − Mt0] =

1
m

(Mt

(i) − Mt0

(i)),

m(cid:88)
m(cid:88)

i=1

i=1

Trade and quote (TAQ) data for 110,000 examples of liquid-
ity shocks across several securities and trading times were
obtained directly from the competition website. Each exam-
ple includes information on 50 transactions leading to the
shock and an equal number after the shock. All prices are
measured in units of pence. For pre-shock transactions, the
data provides (i) nature (trade/quote), (ii) time, (iii) best
bid price, and (iv) best ask price for each transaction. Re-
garding the shock itself, we are provided (i) volume-weighted
average price, (ii) volume, and (iii) nature (buy/sell initi-
ated) of the trade causing the liquidity shock. Addition-
ally, we are also provided (i) the number of previous day
on-market trades, and (ii) sum of previous day on-market
trade values. For post-shock transactions, only data on bid
and ask prices is available.

Of the total data, 80,000 examples were randomly chosen
to form the training set, 20,000 were held out for optimizing
parameters in SVR and the remaining 10,000 were desig-
nated as the test set.

3.1 Mean-reversion of mid and spread

Prior to exploring learning algorithms, we begin with a sta-
tistical characterization of the provided high-frequency data
to verify the observations in [3]. Denoting Bt, At as the
best bid and ask prices for a given time t, the mid price and
bid-ask spread are respectively deﬁned as

Mt =

At + Bt

2

, St = At − Bt.

(1)

For liquid securities, both the mid-price and spread are of-
ten assumed to be mean reverting over short time horizons,
i.e. they have a tendency to return to some non-observable
mean levels. The time series for both quantities can then be
represented by Ornstein-Uhlenbeck (OU) processes [10],

,

t

dMt = αM (µM − Mt)dt + σM dBM
dSt = αS(µS − St)dt + σSdBS
t ,
where BM
, BS
t are standard Brownian motions, σM , σS
t
are the respective volatilities, µM , µS are the mean levels,
and the critical quantities αM , αS are the rates of mean
reversion. The two processes are correlated Cov(BM
t ) =
t
ρt. Owing to linearity in the diﬀusion term, one can show

, BS

(2)

2

ˆE[St − St0] =

1
m

(St

(i) − St0

(i)),

(4)

as a function of time, where m denotes the number of ex-
amples. The post-shock values of these quantities for the
training set are plotted in Fig. 1. A distinction is made
between buy-initiated and sell-initiated shocks as they in-
ﬂuence the mid-price in opposite directions. We see that
both the mid-price and bid-ask spread exhibit strong mean
reversion.
In the case of a buy-initiated shock, the mean
level is higher than than the value prior to the shock, i.e.
the shock increases the long-term or macro level price of
the security. The corresponding decrease happens for a sell-
initiated stock. This phenomenon captures the basic process
by which securities change in value over time. The mean
level for the spread is slightly higher than the pre-shock
level. This highlights the impact of the shock in reducing
liquidity of the security.

Figure 1: Mean reversion of mid-price and bid-ask spread

3.2 Benchmark

We use the statistical estimators in Eqn. (4) as our bench-
mark algorithm,

ˆMt = Mt0 + ˆE[Mt − Mt0],
ˆBt = ˆMt − ˆSt/2,

ˆAt = ˆMt + ˆSt/2,

ˆSt = St0 + ˆE[St − St0 ],

(5)

2468101214−0.5−0.4−0.3−0.2−0.100.10.20.30.40.5t−t0ˆE[Mt−Mt0],ˆE[St−St0]  mid−price − buy−initmid−price − sell−initspreadwhere ˆBt, ˆAt are the predicted values. This corresponds to
a linear mean model consisting of only the intercept term
and no features. As dictated by the competition organizers,
accuracy is measured in terms of the root mean square error
across the entire set,

log(RMSE(i)), i =
Figure 2 records the histogram of
1, . . . , m. We see that the data has a relatively fat right
tail with a few isolated errors as large as 45 pence! The
extreme values are outliers generated by trading events at
the beginning of a day’s trading [9]. However, the smooth
part of the right tail is due to the fact that higher priced
securities have higher volatilities (see Section 5). This was
also observed in [5] where the authors suggested that past
volatility is a strong indicator of liquidity. Performance of
the benchmark is recorded in Table 3.

(cid:34)
(cid:34)

RMSE(i) =

RMSE =

t0+50(cid:88)
RMSE(i)(cid:17)2
(cid:16)
m(cid:88)

(B(i)

t=t0+1

(cid:35)1/2
t − ˆB(i)

,

1
100

1
m

i=1

t )2 + (A(i)

t − ˆA(i)
t )2

(cid:35)1/2

,

(6)

4.1 Coeﬃcient of determination

The eﬀect of incorporating linear feature-terms can be quan-
tiﬁed by measuring the fraction of the response’s variance
that is explained by the features. This is expressed by the
coeﬃcient of determination [11],

R2 = 1 −

SSres
SStot

=

SSreg
SStot

,

(7)

Figure 3 plots this statistic against the 50 post-shock re-
sponse variables for each of the three types of responses.
We see that for t − t0 > 2, the linear model captures less
than 10% of the variance in the response. In other words,
high frequency market ﬂuctuations (increments in mid or
spread) are essentially indiﬀerent to the type of security or
pre-shock transaction history. The linear model merely cap-
tures the mean behavior expressed by the benchmark. This
explains why top participants in the competition failed to
improve on the performance from linear regression despite
trying non-linear supervised and unsupervised learning al-
gorithms. Note that the response right after the shock has
R2 = 1; this is a consequence of repetition in the data sup-
plied by the problem organizers.

Figure 2: Histogram of log(RMSE(i)) for the benchmark.

Figure 3: R2 for the 50 post-shock variables

4 Linear Regression & Diagnostics

The simplest extension of the benchmark algorithm is to in-
corporate ﬁrst order terms of available features in the mean
model. This can be achieved by regressing linearly onto
all 206 available features (pre-shock transactions, at shock
transaction and security speciﬁc scalars). Three sets of mod-
els are trained to predict the ﬁfty discrete post-shock values
of (i) mid-price for a buy-initiated shock, (ii) mid-price for
a sell-initiated shock, and (iii) spread. Extensive analysis is
performed to determine the bias/variance trade-oﬀ of this
simple approach, and to measure the predictive ability of
the feature set.

4.2 Non-normality of residuals

Linear regression is formulated under the assumption that
the response is distributed normally about the mean model.
We can test this assumption by plotting the empirical quan-
tiles of the regression residuals against the quantiles of a
normal distribution with zero mean and variance equal to
the empirical variance of the residuals. Figure 4 records the
QQ plot of the spread-residual at t − t0 = 2. We see that
the data is exceptionally fat-tailed with the largest values
greater then 10 pence!. This is in line with the observations
in Section 3.2.

3

−3−2−101234050100150200250log(RMSE)Count0102030405000.10.20.30.40.50.60.70.80.91t−t0R−squared  mid−price − buy−initmid−price − sell−initspreadFigure 4: QQ plot for Leave-One-Out Cross Validation

Figure 5: RMSE learning curve for linear regression

4.2.1 Leave-one-out CV

5 k-means Clustering

We can further verify the fat-tailed nature of the response
by performing leave-one-out cross validation for the linear
model and observing the change in prediction for the held-
out example,

−i
i = yi − ˆy
i

,

i = 1, 2, . . . , m,

(8)

where yi is the observed response for the ith example, and
−i
is the prediction for the ith example using all except the
ˆy
i
ith example. In the case of linear regression, a simpliﬁcation
can be achieved [11] using the Sherman-Morrison formula
that allows for an analytical expression of the form,

i =

ˆyi

1 − Hii

,

i = 1, 2, . . . , m,

(9)

where ˆyi is the prediction for the ith example using all m
examples and Hii is the leverage of the ith example. The
QQ plot of leave-one-out residuals is also recorded in Figure
4. Once again. the fat tails are evident. In section 5, we
show, empirically, that these fat-tails are largely on account
of heteroskedasticity, since diﬀerent securities have diﬀerent
inherent volatilities.

4.3 Learning curve

We have already seen that the entire set of 206 linear features
has very little prediction power beyond the benchmark for
most of the response variables. Figure 5 plots the learning
curve for RMSE (Eqn. (6)) where the test error is calculated
on the 20,000 examples in the held-out set mentioned in
Section 3. The plot shows that the linear model suﬀers from
high bias, with a rapid plateau of test error and increasing
training error. This indicates that either the current model
is not capturing nonlinear dependence on the features, or
that the overall RMSE is largely controlled by the outliers
mentioned in Section 4.2.1. In the upcoming sections, we
provide some evidence of the latter.

As mentioned in Sections 3.2 and 4.2.1, we claim that the
non-normality of the regression residuals is largely due to
diﬀerent variances for diﬀerent training examples. This
claim is motivated from the observation that price processes
are often modeled as geometric Brownian motions wherein
the volatility is proportional to the price, i.e. we expect
higher priced securities to have higher volatilities. In par-
ticular, from Eqn. (6),

RMSE2

bench (cid:39)

1
m

E

Var(B(i)

t ) + Var(A(i)
t )

,

(10)

(cid:104)

m(cid:88)

i=1

(cid:105)

which shows that each example contributes error propor-
tional to its variance. This can be empirically veriﬁed by
training separate models on clusters sorted by bid price.
Towards this end, we use k-means to identify 3 centroids in
the training data, train 3 sets of models, and record the cor-
responding RMSE values for clusters in the test set. Table
2 shows that RMSE grows with growing cluster price, con-
ﬁrming our claim. Hence, the RMSE for the full test set is
largely dictated by the proportion of high priced securities.

Centroid

RMSE
RMSFE

Clusters

£3.27
0.42p
0.33

£11.75
1.60p
0.34

£22.77
1.90p
0.34

Table 2: Clustering with 3-means based on bid price

In order to circumvent this limitation, we deﬁne an alter-

native metric, the Root Mean Square Fractional Error,

(cid:32)

t0+50(cid:88)

t=t0+1

1
100

B(i)
t − ˆB(i)

t

δ

(cid:33)2

(cid:32)

+

A(i)
t − ˆA(i)

t

δ

m(cid:88)

i=1

(11)

(cid:33)21/2

,

δ = max{max

t

Bt − min

t

Bt, max

t

At − min

t

At},

(12)

RMSFE

 1

m

=

4

−505−10−50510Standard Normal QuantilesQuantilesofresidual:ǫ(∆St0+2)  LR residualLOOCV resdiual00.20.40.60.811.21.41.61.82x 1040.40.60.811.21.41.61.822.22.4Number of samplesRoot Mean Square Error (RMSE)  Test ErrorTrain Errorwhich measures the fraction of volatility of the response that
is explained by the learning algorithm. Table 2 shows that
RMSFE remains nearly constant across the clusters as de-
sired.

6 Weighted LR: heteroskedasticity

The empirical observations from the previous section show
that the normality assumption in vanilla linear regression
is clearly violated. An improvement can be readily incor-
porated by estimating the volatility of each example from
pre-shock prices,

t0(cid:88)
t0(cid:88)

t=1

2

σ(i)
M

(cid:39) (ˆσ(i)

M )2 =

2

σ(i)
S

(cid:39) (ˆσ(i)

S )2 =

1

t0 − 1

1

t0 − 1

t=1

(M (i)

t − ¯M (i))2,

(S(i)

t − ¯S(i))2,

(13)

These diﬀering volatilities can be accommodated in the re-
gression by weighting the examples inversely by their vari-
ances. In particular,

S(i)
t =

θjz(i)

j + (i)
S ,

i = 1, . . . , M, t > t0

(cid:88)
(cid:16)

j

2(cid:17)

(i)
S ∼ N

0, σ(i)
S

Figure 6: ν-SVR : RMSE/RMSFE on a grid of (C,γ).

achieved by calculating errors over the 50 response variables
for a grid of parameter values. For computational ease, ν
is ﬁxed at 1/2. As the training set is massive and for each
point 50 models must be trained, we perform this grid search
using a small training set of 5,000 examples cross validated
against a held-out set of 1,000 samples. The contour plot
for both RMSE and RMSFE is recorded in Fig. 6. We see
that the smallest generalization error is obtained for very
small values of γ in the RBF kernel, i.e. the optimal model
is essentially linear in the features.

Limited by computational expense, we use optimal values
from Fig. 6 and train on the held-out set containing 20,000
samples, instead of the full training set.

,

(14)

8 Performance and Conclusion

where zj, j = 1, . . . , 206 denote the features. Denoting
−2
S i,j = (1/σ(i)
Σ
tors, the normal equations for this case are given by

)1i=j and using boldface for denote vec-

S

2

ZT Σ

−2
S Zθ = ZT Σ

−2
S St.

(15)

Such a weighted linear regression results in signiﬁcant im-
provement of the RMSFE (see Table 3) while the RMSE
remains roughly the same, as expected.

7 Support Vector Regression

In this section we show that the lack of ﬁt for linear re-
gression is not due to a non-linear interrelation between the
response and features. This further builds upon the discus-
sion from Section 4.3. Towards this end, we use LIBSVM
[12] to train a non-linear regression model based on ν-SVR,

min

w,b,ξ(cid:23)0,ξ∗(cid:23)0,≥0

1
2

wT w + Cν +

1T (ξ + ξ∗

),

C
l

s.t. wT φ(zi) + b − yi ≤  + ξi,
∗
− wT φ(zi) − b + yi ≤  + ξ
i ,

i = 1, . . . , m,
(16)

where z is the vector of features, y is the response and C, ν
are regularization parameters. We choose the radial basis
function as our kernel for the inner product,

< φ(z1), φ(z2) >= exp(cid:0)

−γ(cid:107)z1 − z2(cid:107)2

2

(17)

(cid:1) .

As directed by the authors in [13], we begin by determin-
ing reasonable choices for the parameters C and γ. This is

5

Algorithm
Benchmark
Linear Regression
Weighted LR
SVR

Train

Test

RMSE RMSFE RMSE RMSFE

1.41
1.26
1.36
—

2.23
0.51
0.35
—

1.23
1.16
1.20
1.19

1.26
0.40
0.34
0.45

Table 3: Comparative performance of the algorithms.

Table 3 records the training and testing RMSE (Eqn. (6))
and RMSFE (Eqn. (11)) for the four algorithms described
in the previous sections. The results for RMSE are similar
to those obtained by top kaggle-competition participants in
Table 1. Note that the actual values diﬀer since the test sets
are diﬀerent (the competition test set was not made public).
All algorithms produce RMSE values very close to that of
the benchmark showing that learning based on pre-shock
data was not beneﬁcial for RMSE. However, for the frac-
tional error, RMSFE, learning algorithms provide signiﬁcant
improvement over the benchmark. Among the three super-
vised learning models, weighted LR performs best, yielding
an eﬃcient prediction algorithm for high frequency data.

The table strongly supports the claims made in Sections
4.1, 5 and 7. The RMSE of the test set is largely dic-
tated by high priced securities associated with high volatil-
ity. Thus, adding linear/non-linear features adds very little
predictive capability in comparison to the benchmark. How-
ever, RMSFE, which normalizes error by volatility, indeed
decreases as the algorithm is reﬁned, showing that the fea-
tures do have some intrinsic predictive capability in this new
measure.

log2(Cost)log2(Gamma)  −5−4−3−2−10123−10−8−6−4−202RMSE1.061.081.11.121.141.161.18log2(Cost)log2(Gamma)  −5−4−3−2−10123−10−8−6−4−202RMSFE0.811.21.41.61.822.22.42.6References

[1] Lawrence R. Glosten, ‘Is the electronic open limit order book inevitable?’, The Journal of Finance 49.4 1127-1161

(1994).

[2] Christine A. Parlour, ‘Price dynamics in limit order markets’, Review of Financial Studies 11.4 789-816 (1998).

[3] Bruno Biais, Pierre Hillion, and Chester Spatt, ‘An empirical analysis of the limit order book and the order ﬂow in

the Paris Bourse’, Journal of Finance 1655-1689 (1995).

[4] Thierry Foucault, Ohad Kadan, and Eugene Kandel, ‘Limit order book as a market for liquidity’, Review of Financial

Studies 18.4 1171-1217 (2005).

[5] Tarun Chordia, Asani Sarkar, Avanidhar Subrahmanyam, ‘An Empirical Analysis of Stock and Bond Market Liquid-

ity’, The Review of Financial Studies Vol. 18, No. 1 (2005).

[6] Ming Huang, ‘Liquidity shocks and equilibrium liquidity premia’, Journal of Economic Theory 109 104–129 (2003).

[7] Bruno Biais, Paul Woolley, ‘High Frequency Trading’, Toulouse School of Economics, London School of Economics,

(2011).

[8] John H. Cochrane, Monika Piazzesi,

‘The

fed and interest

rates:

a high-frequency identiﬁcation’,

http://www.nber.org/papers/w8839, National bureau of economic research, (2002).

[9] URL: https://www.kaggle.com/c/AlgorithmicTradingChallenge/.

[10] G. E. Uhlenbeck, L. S. Ornstein, ‘On the theory of Brownian Motion’, Phys. Rev. 36: 823–841 (1930).

[11] Peter Dalgaard,‘Introductory statistics with R. Springer Science & Business Media’, (2008).

[12] Chih-Chung Chang, Chih-Jen Lin. ‘LIBSVM: A library for support vector machines’, ACM Transactions on Intelligent

Systems and Technology (TIST) 2.3 : 27 (2011).

[13] Chih-Wei Hsu, Chih-Chung Chang, Chih-Jen Lin, ‘A practical guide to support vector classiﬁcation’, (2003).

6

